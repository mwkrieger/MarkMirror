<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wall Dashboard</title>
  <script>
    (function() {
      let lastHash = '';
      let isReloading = false;
      async function checkForUpdates() {
        try {
          const res = await fetch('/api/code-version');
          const data = await res.json();
          if (!lastHash) { lastHash = data.hash; return; }
          if (data.hash !== lastHash && !isReloading) {
            isReloading = true;
            const n = document.createElement('div');
            n.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#4caf50,#81c784);color:#fff;padding:15px 30px;border-radius:8px;font-weight:bold;z-index:99999;box-shadow:0 4px 20px rgba(0,0,0,0.3)';
            n.textContent = '‚ú® Dashboard updating...';
            document.body.appendChild(n);
            setTimeout(() => window.location.reload(true), 1000);
          }
        } catch (error) {}
      }
      checkForUpdates();
      setInterval(checkForUpdates, 10000);
      console.log('üîÑ Hot-reload enabled');
    })();

    // Show admin button on click
    (function() {
      const adminBtn = document.querySelector('.admin-btn');
      let adminTimeout;
      
      document.addEventListener('click', (e) => {
        if (e.target === adminBtn || adminBtn.contains(e.target)) return;
        
        adminBtn.classList.add('visible');
        clearTimeout(adminTimeout);
        
        // Hide after 5 seconds of inactivity
        adminTimeout = setTimeout(() => {
          adminBtn.classList.remove('visible');
        }, 5000);
      });
    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       MAIN DASHBOARD
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    .container { 
      display: grid; 
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: auto 1fr auto;
      width: 100%;
      height: 100vh;
      padding: 30px;
      gap: 20px;
    }

    /* Admin button - hidden until click */
    .admin-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #999;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }

    .admin-btn.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .admin-btn:hover {
      background: rgba(255,255,255,0.15);
      color: #e0e0e0;
    }

    /* Header: Time, Date, Temps */
    .top-left {
      grid-column: 1;
      grid-row: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding-top: 10px;
    }

    .date { 
      font-size: 1.1rem; 
      color: #e0e0e0;
      margin-top: 0;
      margin-bottom: 12px;
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    .time { 
      font-size: 90px; 
      font-weight: 900; 
      letter-spacing: -3px; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      line-height: 1;
      display: flex;
      align-items: flex-start;
      gap: 0;
      margin-bottom: 8px;
    }

    .time-seconds {
      font-size: 0.38em;
      margin-top: -0.2em;
      margin-left: 2px;
      color: #a0a0a0;
      vertical-align: super;
      font-weight: 700;
    }

    .time-ampm {
      font-size: 0.45em;
      margin-left: 8px;
      color: #999;
      margin-top: 0.15em;
      font-weight: 600;
    }

    .sun-times { 
      font-size: 0.9rem; 
      color: #999; 
      margin-top: 12px;
      display: flex;
      flex-direction: row;
      gap: 16px;
      line-height: 1.4;
      text-align: left;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .sun-times span {
      display: flex;
      flex-direction: row;
      gap: 6px;
      align-items: center;
      font-size: 0.9rem;
      color: #bbb;
    }

    .sun-icon {
      font-size: 1.1em;
    }
    
    .moon-icon {
      font-size: 1.1em;
    }
    
    .sun-arrow {
      font-size: 0.9em;
      color: #999;
      min-width: 8px;
      text-align: center;
    }

    .temps-box {
      font-size: 0.85rem;
      margin-top: 25px;
      color: #aaa;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      line-height: 1.4;
    }

    .temps-box > div {
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 14px;
      transition: all 0.3s ease;
    }
    
    .temps-box > div:hover {
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.05));
      border-color: rgba(255,255,255,0.2);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .temps-box .label { 
      color: #666; 
      font-size: 0.7rem; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .temps-box .value { 
      color: #e0e0e0; 
      font-size: 1.2rem;
      font-weight: 600;
    }

    /* Countdown Timers */
    .timers-section {
      grid-column: 1;
      grid-row: 1;
      align-self: flex-end;
      margin-top: 20px;
    }

    .timer-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 0.85rem;
    }

    .timer-label {
      color: #999;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .timer-value {
      font-size: 1.5rem;
      font-weight: bold;
      font-family: 'Monaco', monospace;
    }

    /* Top Middle: Crypto */
    .top-middle {
      grid-column: 2;
      grid-row: 1;
      text-align: center;
    }

    .section-title { 
      font-size: 0.75rem; 
      text-transform: uppercase; 
      letter-spacing: 2px; 
      color: #666; 
      margin-bottom: 15px;
    }

    .crypto-grid {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 15px;
    }

    .crypto-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .crypto-symbol {
      font-size: 2rem;
      font-weight: bold;
      color: #e0e0e0;
    }

    .crypto-price { 
      font-size: 1.3rem; 
      font-weight: bold; 
      color: #e0e0e0;
    }

    .crypto-change { 
      font-size: 0.85rem; 
      color: #888; 
      min-width: 50px;
      text-align: center;
    }

    .crypto-change.up { color: #4caf50; }
    .crypto-change.down { color: #f44336; }

    /* Top Right: Weather */
    .top-right {
      grid-column: 3;
      grid-row: 1;
      text-align: right;
    }

    .weather-main {
      font-size: 75px !important;
      font-weight: bold !important;
      margin-bottom: 5px;
    }

    #weather-temp {
      font-size: 75px !important;
    }

    .weather-desc { 
      font-size: 0.9rem; 
      color: #999; 
      margin-bottom: 15px; 
    }

    .forecast-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-top: 10px;
      font-size: 0.75rem;
    }

    .forecast-item {
      background: rgba(255,255,255,0.02);
      padding: 8px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.05);
      text-align: center;
    }

    .forecast-day { 
      color: #888; 
      margin-bottom: 4px;
      font-size: 0.7rem;
      text-transform: uppercase;
    }
    
    .forecast-temps {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .forecast-high {
      font-weight: bold;
      color: #e0e0e0;
    }
    
    .forecast-low {
      color: #999;
      font-size: 0.9em;
    }

    .weather-summary {
      margin-top: 12px;
      font-size: 0.9rem;
      color: #aaa;
      text-align: center;
      padding: 8px;
      background: rgba(255,255,255,0.03);
      border-radius: 4px;
    }

    .temps-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
      text-align: right;
    }

    .temp-tile {
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: background 0.3s ease;
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Cold: < 55¬∞F - Blue */
    .temp-tile.cold {
      background: linear-gradient(135deg, rgba(30, 58, 138, 0.3), rgba(37, 99, 235, 0.2));
      border-color: rgba(37, 99, 235, 0.4);
    }

    /* Warmer: 55-75¬∞F - Amber/Orange */
    .temp-tile.warmer {
      background: linear-gradient(135deg, rgba(146, 64, 14, 0.3), rgba(245, 158, 11, 0.2));
      border-color: rgba(245, 158, 11, 0.4);
    }

    /* Lovely: 75-80¬∞F - Green */
    .temp-tile.lovely {
      background: linear-gradient(135deg, rgba(21, 128, 61, 0.3), rgba(34, 197, 94, 0.2));
      border-color: rgba(34, 197, 94, 0.4);
    }

    /* Hot: > 80¬∞F - Red */
    .temp-tile.hot {
      background: linear-gradient(135deg, rgba(127, 29, 29, 0.3), rgba(220, 38, 38, 0.2));
      border-color: rgba(220, 38, 38, 0.4);
    }

    .temp-location {
      font-size: 0.7rem;
      color: #bbb;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .temp-value {
      font-size: 1.3rem;
      color: #f0f0f0;
      font-weight: 600;
    }

    .humidity-value {
      font-size: 0.85rem;
      color: #aaa;
    }

    /* Main Content: Powerwall + Graphs */
    .main {
      grid-column: 1 / 4;
      grid-row: 2;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 30px;
      padding: 20px 0;
      overflow: auto;
    }

    .powerwall-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* Status Circle Indicators */
    .status-circle {
      position: relative;
      width: clamp(120px, 20vw, 200px);
      height: clamp(120px, 20vw, 200px);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px auto;
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
    }

    .status-circle.solar {
      background: radial-gradient(circle at 30% 30%, #64b5f6, #1976d2);
    }

    .status-circle.self-powered {
      background: radial-gradient(circle at 30% 30%, #e8eaf6, #3f51b5);
      border: 8px solid #fff;
    }

    .status-circle-inner {
      width: 80%;
      height: 80%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0a0a0a;
      flex-direction: column;
    }

    .status-circle-inner.solar .inner {
      width: 40%;
      height: 40%;
      background: #ffd700;
      border-radius: 50%;
    }

    .status-circle-inner.load {
      width: 75%;
      height: 75%;
      background: rgba(100, 181, 246, 0.1);
    }

    .status-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #999;
      margin-top: 15px;
    }

    .status-value {
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      font-weight: bold;
      margin-top: 5px;
    }

    .status-value.yellow { color: #ffd700; }
    .status-value.blue { color: #64b5f6; }
    .status-value.green { color: #4caf50; }
    .status-value.white { color: #e0e0e0; }

    /* Battery Bar */
    .battery-bar {
      width: 150px;
      height: 80px;
      background: #1a1a1a;
      border: 2px solid #4caf50;
      border-radius: 8px;
      margin: 20px auto;
      position: relative;
      overflow: hidden;
    }

    .battery-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #81c784);
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      color: #000;
    }

    .battery-label { 
      text-align: center; 
      font-size: 0.7rem; 
      color: #666;
      margin-top: 8px;
    }

    /* Grid Power */
    .grid-power {
      display: flex;
      align-items: center;
      gap: 20px;
      margin: 30px 0;
    }

    .grid-icon {
      font-size: 60px;
      filter: brightness(0.8);
    }

    .grid-value {
      font-size: clamp(1.5rem, 4vw, 3rem);
      font-weight: bold;
      color: #e0e0e0;
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 200px;
      margin: 20px 0;
      width: 100%;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      padding: 10px;
    }

    .chart-title {
      font-size: 0.8rem;
      color: #666;
      text-align: center;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    /* Bottom: Grid + News */
    .bottom {
      grid-column: 1 / 4;
      grid-row: 3;
      border-top: 1px solid rgba(255,255,255,0.05);
      padding-top: 15px;
      font-size: 0.85rem;
      color: #666;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .news {
      flex: 1;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .news-source {
      color: #999;
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .news-text {
      color: #ccc;
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       ADMIN PANEL
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      overflow-y: auto;
      padding: 40px;
    }

    .modal.active {
      display: block;
    }

    .modal-content {
      background: #1a1a1a;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
    }

    .modal-close {
      position: fixed;
      top: 20px;
      right: 40px;
      font-size: 2rem;
      color: #999;
      cursor: pointer;
      background: none;
      border: none;
    }

    .modal-close:hover {
      color: #e0e0e0;
    }

    .modal h2 {
      font-size: 1.8rem;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 15px;
    }

    .modal h3 {
      font-size: 1.2rem;
      margin-top: 30px;
      margin-bottom: 15px;
      color: #999;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 0.9rem;
      color: #999;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: #e0e0e0;
      border-radius: 6px;
      font-size: 0.95rem;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.08);
    }

    .btn {
      background: #4caf50;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s;
    }

    .btn:hover {
      background: #66bb6a;
    }

    .btn.danger {
      background: #f44336;
      color: #fff;
    }

    .btn.danger:hover {
      background: #da190b;
    }

    .timer-list {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
    }

    .timer-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 0.9rem;
    }

    .timer-entry:last-child {
      border-bottom: none;
    }

    .timer-entry-info {
      flex: 1;
    }

    .timer-entry-name {
      font-weight: bold;
      color: #e0e0e0;
    }

    .timer-entry-time {
      font-size: 0.8rem;
      color: #999;
    }

    /* Mobile responsive */
    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr auto;
        padding: 20px;
        gap: 15px;
      }

      .top-left, .top-middle, .top-right {
        grid-column: 1 !important;
        grid-row: auto !important;
      }

      .main {
        grid-column: 1 !important;
        grid-row: auto !important;
        grid-template-columns: 1fr;
      }

      .bottom {
        grid-column: 1 !important;
        grid-row: auto !important;
        flex-direction: column;
        gap: 15px;
      }

      .time {
        font-size: 90px;
      }

      .crypto-price {
        font-size: 1.5rem;
      }

      .weather-main {
        font-size: 75px !important;
      }
      
      #weather-temp {
        font-size: 75px !important;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
        gap: 10px;
      }

      .temps-box {
        grid-template-columns: 1fr;
        font-size: 0.75rem;
      }

      .forecast-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      .temps-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .admin-btn {
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 0.7rem;
      }
    }

    .loading { 
      opacity: 0.5; 
      animation: pulse 1.5s infinite; 
    }

    @keyframes pulse { 
      0%, 100% { opacity: 0.5; } 
      50% { opacity: 1; } 
    }

    .error { 
      color: #f44336; 
      font-size: 0.85rem; 
    }

    @keyframes dataPulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    #pw-self-powered {
      background: linear-gradient(45deg, #64b5f6, #4caf50, #64b5f6);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
      padding: 8px 12px;
      border-radius: 6px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <button class="admin-btn" onclick="toggleAdmin()">‚öôÔ∏è ADMIN</button>

  <div class="container">
    <!-- TOP LEFT: Time, Date, Temps, Timers -->
    <div class="top-left">
      <div class="date" id="date"></div>
      <div class="time">
        <span id="time-main">00:00</span><span class="time-seconds" id="time-seconds">00</span><span class="time-ampm" id="time-ampm">AM</span>
      </div>
      
      <div class="sun-times">
        <span>
          <span class="sun-icon">‚òÄÔ∏è</span>
          <span class="sun-arrow">‚Üë</span>
          <span id="sunrise">--:--</span>
        </span>
        <span>
          <span class="sun-icon">‚òÄÔ∏è</span>
          <span class="sun-arrow">‚Üì</span>
          <span id="sunset">--:--</span>
        </span>
        <span>
          <span class="moon-icon">üåô</span>
          <span class="sun-arrow">‚Üë</span>
          <span id="moonrise">--:--</span>
        </span>
        <span>
          <span class="moon-icon">üåô</span>
          <span class="sun-arrow">‚Üì</span>
          <span id="moonset">--:--</span>
        </span>
      </div>

      <div class="timers-section" id="timers-display"></div>
    </div>

    <!-- TOP MIDDLE: Crypto -->
    <div class="top-middle loading" id="crypto-card">
      <div class="section-title">CRYPTO</div>
      <div class="crypto-grid">
        <div class="crypto-item">
          <div class="crypto-symbol">‚Çø</div>
          <div class="crypto-price" id="btc-price">$--</div>
          <div class="crypto-change" id="btc-change">--%</div>
        </div>
        <div class="crypto-item">
          <div class="crypto-symbol">Œû</div>
          <div class="crypto-price" id="eth-price">$--</div>
          <div class="crypto-change" id="eth-change">--%</div>
        </div>
      </div>
    </div>

    <!-- TOP RIGHT: Weather -->
    <div class="top-right loading" id="weather-card">
      <div class="section-title">WEATHER ‚Äî 18428</div>
      <div class="weather-main" id="weather-temp">--¬∞</div>
      <div class="weather-desc" id="weather-feels">Feels like --¬∞</div>
      
      <div class="forecast-grid" id="forecast-grid">
        <!-- Populated by JavaScript -->
      </div>

      <div class="weather-summary" id="weather-summary">
        Partly cloudy, 42¬∞
      </div>

      <div class="temps-grid">
        <div class="temp-tile">
          <div class="temp-location">INSIDE</div>
          <div class="temp-value" id="temp-inside">--¬∞</div>
          <div class="humidity-value" id="humidity-inside">-- %</div>
        </div>
        <div class="temp-tile">
          <div class="temp-location">BASEMENT</div>
          <div class="temp-value" id="temp-basement">--¬∞</div>
          <div class="humidity-value" id="humidity-basement">-- %</div>
        </div>
        <div class="temp-tile">
          <div class="temp-location">OUTSIDE</div>
          <div class="temp-value" id="temp-outside">--¬∞</div>
          <div class="humidity-value" id="humidity-outside">-- %</div>
        </div>
        <div class="temp-tile">
          <div class="temp-location">POOL</div>
          <div class="temp-value" id="temp-pool">--¬∞</div>
        </div>
      </div>
    </div>

    <!-- MAIN: Powerwall + Energy Flow (Triangular) -->
    <div class="main" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; grid-column: 1/4; grid-row: 2;">
      <!-- Left: Status Tile -->
      <div style="background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; text-align: center;">
        <div class="status-label">Self-Powered</div>
        <div class="status-value white" id="pw-self-powered" style="font-size: 2.2rem; margin: 10px 0;">-- %</div>
        <div style="font-size: 0.8rem; color: #999;">
          <div id="battery-status" style="margin-bottom: 8px;">Standby</div>
          <div id="grid-status" style="margin-bottom: 4px;">Grid: --</div>
          <div id="battery-soe-status">Battery: --%</div>
        </div>
      </div>

      <!-- Center-Left: Energy Flow Tile (Triangular) -->
      <div style="background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; display: flex; align-items: center; justify-content: center;">
        <svg viewBox="0 0 200 220" xmlns="http://www.w3.org/2000/svg" class="energy-flow-pyramid" style="width: 100%; height: 100%;">
          <defs>
            <style>
              .pyr-label { font-size: 10px; font-weight: bold; fill: #ccc; text-anchor: middle; }
              .pyr-value { font-size: 14px; font-weight: bold; fill: #fff; text-anchor: middle; }
              .pyr-icon { font-size: 24px; text-anchor: middle; }
              .flow-line { fill: none; stroke-width: 1.5; stroke-linecap: round; }
              .solar-line { stroke: #ffd700; }
              .battery-line { stroke: #4caf50; }
              .grid-line { stroke: #f44336; }
              .pyr-dot { fill: #fff; opacity: 0.9; }
            </style>
            <filter id="pyr-glow"><feGaussianBlur stdDeviation="1" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          </defs>
          
          <!-- Top: SOLAR -->
          <text x="100" y="20" class="pyr-icon">‚òÄÔ∏è</text>
          <text x="100" y="38" class="pyr-label">SOLAR</text>
          <text x="100" y="52" class="pyr-value" id="pyr-solar">0.0</text>
          
          <!-- Bottom-Left: GRID -->
          <text x="40" y="190" class="pyr-icon">‚ö°</text>
          <text x="40" y="208" class="pyr-label">GRID</text>
          <text x="40" y="215" class="pyr-value" id="pyr-grid" style="font-size: 12px;">0.0</text>
          
          <!-- Bottom-Right: BATTERY -->
          <text x="160" y="190" class="pyr-icon">üîã</text>
          <text x="160" y="208" class="pyr-label">BATT</text>
          <text x="160" y="215" class="pyr-value" id="pyr-battery" style="font-size: 12px;">0.0</text>
          
          <!-- Center: HOME -->
          <circle cx="100" cy="120" r="18" fill="rgba(255,255,255,0.1)" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
          <text x="100" y="125" class="pyr-icon" style="font-size: 28px;">üè†</text>
          
          <!-- Flow lines from sources to home -->
          <path d="M 100 60 L 100 100" class="flow-line solar-line" id="pyr-solar-line"/>
          <circle cx="100" cy="75" r="2.5" class="pyr-dot solar-line" filter="url(#pyr-glow)" id="pyr-solar-dot"/>
          
          <path d="M 50 180 L 85 130" class="flow-line grid-line" id="pyr-grid-line"/>
          <circle cx="65" cy="155" r="2.5" class="pyr-dot grid-line" filter="url(#pyr-glow)" id="pyr-grid-dot"/>
          
          <path d="M 150 180 L 115 130" class="flow-line battery-line" id="pyr-battery-line"/>
          <circle cx="135" cy="155" r="2.5" class="pyr-dot battery-line" filter="url(#pyr-glow)" id="pyr-battery-dot"/>
        </svg>
      </div>

      <!-- Center-Right: Power Breakdown Tile -->
      <div style="background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; text-align: center;">
        <div class="status-label">LOAD</div>
        <div class="status-value blue" id="pw-load" style="font-size: 2rem; margin: 10px 0;">-- W</div>
        <div style="font-size: 0.75rem; color: #999; line-height: 1.6; margin-top: 12px;">
          <div style="margin-bottom: 6px;">‚òÄÔ∏è Solar: <span id="tile-solar">0.0</span>kW</div>
          <div style="margin-bottom: 6px;">üîã Batt: <span id="tile-battery">0.0</span>kW</div>
          <div>‚ö° Grid: <span id="tile-grid">0.0</span>kW</div>
        </div>
      </div>

      <!-- Right: 24-Hour Chart Tile -->
      <div style="background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px;">
        <div class="chart-title" style="font-size: 0.85rem; margin-bottom: 8px;">24h Power</div>
        <canvas id="powerChart" style="max-height: 160px;"></canvas>
      </div>
    </div>

    <!-- BOTTOM: Grid + News -->
    <div class="bottom">
      <div class="grid-power">
        <div class="grid-icon">‚ö°</div>
        <div>
          <div style="font-size: 0.8rem; color: #666;">Grid is supplying</div>
          <div class="grid-value" id="pw-grid">-.- kW</div>
        </div>
      </div>

      <div class="news">
        <span class="news-source">TECHCRUNCH, 19 minutes ago:</span>
        <span class="news-text" id="news">Loading news...</span>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div class="modal" id="adminModal">
    <button class="modal-close" onclick="toggleAdmin()">‚úï</button>
    <div class="modal-content">
      <h2>‚öôÔ∏è Admin Dashboard</h2>

      <h3>üìç Countdown Timers</h3>
      <div class="form-group">
        <label>Timer Name</label>
        <input type="text" id="timerName" placeholder="e.g., Dinner ready, Battery charge complete">
      </div>
      <div class="form-group">
        <label>Target Time</label>
        <input type="datetime-local" id="timerTime">
      </div>
      <div class="form-group">
        <label>Color</label>
        <input type="color" id="timerColor" value="#4caf50">
      </div>
      <button class="btn" onclick="addTimer()">+ Add Timer</button>

      <div class="timer-list" id="timersList"></div>

      <h3>üìä Historical Data</h3>
      <button class="btn" onclick="downloadHistory('24h')">Download 24hr Data</button>
      <button class="btn" onclick="downloadHistory('7d')">Download 7-day Data</button>
      <button class="btn" onclick="downloadHistory('30d')">Download 30-day Data</button>

      <h3>‚öôÔ∏è System Settings</h3>
      <div class="form-group">
        <label>Theme</label>
        <select id="themeSelect">
          <option value="dark">Dark (Default)</option>
          <option value="light">Light</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <button class="btn" onclick="saveSettings()">Save Settings</button>

      <p style="margin-top: 30px; font-size: 0.85rem; color: #666;">
        Dashboard v2 ‚Ä¢ Last updated: <span id="lastUpdate">--:--</span>
      </p>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // ADMIN FUNCTIONS
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function toggleAdmin() {
      document.getElementById('adminModal').classList.toggle('active');
      loadTimers();
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }

    async function addTimer() {
      const name = document.getElementById('timerName').value;
      const targetTime = document.getElementById('timerTime').value;
      const color = document.getElementById('timerColor').value;

      if (!name || !targetTime) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const res = await fetch('/api/admin/timers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, targetTime, color })
        });
        await res.json();
        document.getElementById('timerName').value = '';
        document.getElementById('timerTime').value = '';
        loadTimers();
      } catch (error) {
        console.error('Error adding timer:', error);
      }
    }

    async function deleteTimer(id) {
      if (!confirm('Delete this timer?')) return;
      try {
        await fetch(`/api/admin/timers/${id}`, { method: 'DELETE' });
        loadTimers();
      } catch (error) {
        console.error('Error deleting timer:', error);
      }
    }

    async function loadTimers() {
      try {
        const res = await fetch('/api/admin/timers');
        const timers = await res.json();

        const list = document.getElementById('timersList');
        list.innerHTML = timers.map(t => `
          <div class="timer-entry">
            <div class="timer-entry-info">
              <div class="timer-entry-name" style="color: ${t.color}">${t.name}</div>
              <div class="timer-entry-time">${new Date(t.targetTime).toLocaleString()}</div>
            </div>
            <button class="btn danger" onclick="deleteTimer('${t.id}')">Delete</button>
          </div>
        `).join('');

        updateTimersDisplay();
      } catch (error) {
        console.error('Error loading timers:', error);
      }
    }

    async function downloadHistory(range) {
      try {
        const res = await fetch(`/api/admin/history?range=${range}`);
        const data = await res.json();
        
        const csv = 'timestamp,grid,battery,solar,load,soe\n' +
          data.map(h => `${h.timestamp},${h.grid},${h.battery},${h.solar},${h.load},${h.soe}`).join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `powerwall-${range}-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      } catch (error) {
        console.error('Error downloading history:', error);
      }
    }

    function saveSettings() {
      const theme = document.getElementById('themeSelect').value;
      alert(`Settings saved! Theme: ${theme}`);
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // MAIN DASHBOARD FUNCTIONS
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Update clock (H:MM with superscripted seconds and AM/PM)
    function updateClock() {
      const now = new Date();
      let hours = now.getHours();
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12;
      
      document.getElementById('time-main').textContent = `${hours}:${minutes}`;
      document.getElementById('time-seconds').textContent = seconds;
      document.getElementById('time-ampm').textContent = ampm;
      document.getElementById('date').textContent = now.toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
    }

    setInterval(updateClock, 1000);
    updateClock();

    // Update timers display
    async function updateTimersDisplay() {
      try {
        const res = await fetch('/api/admin/timers');
        const timers = await res.json();

        const now = Date.now();
        const display = document.getElementById('timers-display');

        display.innerHTML = timers.map(timer => {
          const target = new Date(timer.targetTime).getTime();
          const diff = target - now;

          if (diff <= 0) {
            return `<div class="timer-item" style="border-color: ${timer.color}">
              <div class="timer-label">${timer.name}</div>
              <div class="timer-value" style="color: ${timer.color}">DONE!</div>
            </div>`;
          }

          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
          const minutes = Math.floor((diff / (1000 * 60)) % 60);
          const seconds = Math.floor((diff / 1000) % 60);

          let display_str = days > 0 
            ? `${days}d ${hours}h` 
            : `${hours}h ${minutes}m`;

          return `<div class="timer-item" style="border-color: ${timer.color}">
            <div class="timer-label">${timer.name}</div>
            <div class="timer-value" style="color: ${timer.color}">${display_str}</div>
          </div>`;
        }).join('');
      } catch (error) {
        console.error('Error updating timers:', error);
      }
    }

    setInterval(updateTimersDisplay, 1000);
    updateTimersDisplay();

    // Fetch weather
    async function fetchWeather() {
      try {
        const res = await fetch('/api/weather');
        const data = await res.json();
        
        document.getElementById('weather-temp').textContent = `${data.current.temp}¬∞`;
        document.getElementById('weather-feels').textContent = `Feels like ${data.current.feelsLike}¬∞`;
        document.getElementById('sunrise').textContent = new Date(data.sunrise).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('sunset').textContent = new Date(data.sunset).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        
        if (data.moonrise) {
          document.getElementById('moonrise').textContent = new Date(data.moonrise).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        if (data.moonset) {
          document.getElementById('moonset').textContent = new Date(data.moonset).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        // Populate daily forecast grid
        const dayNames = ['TODAY', 'TOMORROW', 'FRI', 'SAT', 'SUN'];
        const forecastGrid = document.getElementById('forecast-grid');
        forecastGrid.innerHTML = '';

        if (data.dailyForecast && data.dailyForecast.length > 0) {
          data.dailyForecast.slice(0, 5).forEach((day, i) => {
            const item = document.createElement('div');
            item.className = 'forecast-item';
            item.innerHTML = `
              <div class="forecast-day">${dayNames[i]}</div>
              <div class="forecast-temps">
                <div class="forecast-high">${day.high}¬∞</div>
                <div class="forecast-low">${day.low}¬∞</div>
              </div>
            `;
            forecastGrid.appendChild(item);
          });
        }

        // Update weather summary
        document.getElementById('weather-summary').textContent = 
          `${data.current.description}, ${data.current.temp}¬∞ ‚Äî Feels like ${data.current.feelsLike}¬∞`;

        document.getElementById('weather-card').classList.remove('loading');
      } catch (error) {
        console.error('Weather error:', error);
      }
    }

    // Get temperature category for color coding
    function getTempCategory(temp) {
      if (temp < 55) return 'cold';
      if (temp < 70) return 'warmer';
      if (temp <= 80) return 'lovely';
      return 'hot';
    }

    // Apply temperature category class to tile
    function updateTempTile(locationId) {
      const tempEl = document.getElementById(`temp-${locationId}`);
      if (!tempEl) return;
      
      const tile = tempEl.closest('.temp-tile');
      if (!tile) return;
      
      const tempText = tempEl.textContent;
      const temp = parseInt(tempText);
      
      // Remove all temp classes
      tile.classList.remove('cold', 'warmer', 'lovely', 'hot');
      // Add appropriate class
      tile.classList.add(getTempCategory(temp));
    }

    // Fetch temps
    async function fetchTemps() {
      try {
        const res = await fetch('/api/temps');
        const data = await res.json();
        
        document.getElementById('temp-inside').textContent = `${data.inside.temp}¬∞`;
        document.getElementById('humidity-inside').textContent = `${data.inside.humidity}%`;
        updateTempTile('inside');
        
        document.getElementById('temp-basement').textContent = `${data.basement.temp}¬∞`;
        document.getElementById('humidity-basement').textContent = `${data.basement.humidity}%`;
        updateTempTile('basement');
        
        document.getElementById('temp-outside').textContent = `${data.outside.temp}¬∞`;
        document.getElementById('humidity-outside').textContent = `${data.outside.humidity}%`;
        updateTempTile('outside');
        
        document.getElementById('temp-pool').textContent = `${data.pool.temp}¬∞`;
        updateTempTile('pool');
      } catch (error) {
        console.error('Temps error:', error);
      }
    }

    // Live Powerwall streaming via SSE
    function startPowerwallStream() {
      const eventSource = new EventSource('/api/powerwall/stream');
      
      eventSource.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          
          if (message.type === 'powerwall' && message.data) {
            const data = message.data;
            const gridKW = (data.grid.power / 1000).toFixed(1);
            
            // Update UI with animation pulse
            const displayGridKW = Math.abs(parseFloat(gridKW)) < 0.05 ? '0.0' : gridKW;
            updatePowerwallUI('pw-grid', `${displayGridKW} kW`);
            updatePowerwallUI('pw-solar', `${Math.max(0, data.solar.power)} W`);
            updatePowerwallUI('pw-load', `${data.load.power} W`);
            updatePowerwallUI('pw-self-powered', `${data.selfPoweredPercent}%`);
            
            const soe = Math.round(data.battery.soe);
            document.getElementById('battery-fill').style.width = `${soe}%`;
            document.getElementById('battery-fill').textContent = `${soe}%`;
            
            document.getElementById('battery-soe').textContent = `Battery: ${soe}%`;
            updateBatteryStatus(data.battery.status);
            updateGridStatus(data.grid.isSupplying, data.grid.power);
            
            // Update energy flow visualization
            updateEnergyFlow(data);
            
            document.getElementById('crypto-card').classList.remove('loading');
          }
        } catch (error) {
          console.error('SSE parse error:', error);
        }
      };
      
      eventSource.onerror = (error) => {
        console.error('SSE connection error:', error);
        eventSource.close();
        // Retry connection after 3 seconds
        setTimeout(startPowerwallStream, 3000);
      };
    }
    
    function updatePowerwallUI(elementId, value) {
      const el = document.getElementById(elementId);
      if (el) {
        el.textContent = value;
        // Add pulse animation
        el.style.animation = 'none';
        setTimeout(() => { el.style.animation = 'dataPulse 0.3s ease'; }, 10);
      }
    }

    function updateBatteryStatus(status) {
      const el = document.getElementById('battery-status');
      if (el) {
        if (status === 'discharging') {
          el.textContent = 'üîã Supplying Power';
          el.style.color = '#4caf50';
        } else if (status === 'charging') {
          el.textContent = 'üîå Charging';
          el.style.color = '#2196f3';
        } else {
          el.textContent = 'Standby';
          el.style.color = '#999';
        }
      }
    }

    function updateGridStatus(isSupplying, power) {
      const el = document.getElementById('grid-status');
      if (el) {
        // Clamp small values to 0
        const displayPower = Math.abs(power) < 50 ? 0 : power;
        
        if (displayPower < -100) {
          el.innerHTML = `<span style="color: #4caf50;">‚¨Ü Exporting: ${Math.abs(displayPower).toLocaleString()} W</span>`;
        } else if (displayPower > 100) {
          el.innerHTML = `<span style="color: #f44336;">‚¨á Importing: ${displayPower.toLocaleString()} W</span>`;
        } else {
          el.innerHTML = `<span style="color: #999;">Grid: 0.0 W</span>`;
        }
      }
    }
    
    async function fetchPowerwall() {
      try {
        const res = await fetch('/api/powerwall');
        const data = await res.json();
        
        const gridKW = (data.grid.power / 1000).toFixed(1);
        const displayGridKW = Math.abs(parseFloat(gridKW)) < 0.05 ? '0.0' : gridKW;
        document.getElementById('pw-grid').textContent = `${displayGridKW} kW`;
        document.getElementById('pw-solar').textContent = `${Math.max(0, data.solar.power)} W`;
        document.getElementById('pw-load').textContent = `${data.load.power} W`;
        document.getElementById('pw-self-powered').textContent = `${data.selfPoweredPercent}%`;
        
        const soe = Math.round(data.battery.soe);
        document.getElementById('battery-fill').style.width = `${soe}%`;
        document.getElementById('battery-fill').textContent = `${soe}%`;
        
        document.getElementById('battery-soe').textContent = `Battery: ${soe}%`;
        updateBatteryStatus(data.battery.status);
        updateGridStatus(data.grid.isSupplying, data.grid.power);

        // Update energy flow visualization
        updateEnergyFlow(data);

        document.getElementById('crypto-card').classList.remove('loading');
        
        // Fetch and update history chart
        const historyRes = await fetch('/api/admin/history?range=24h');
        const history = await historyRes.json();
        updateChart(history);
      } catch (error) {
        console.error('Powerwall error:', error);
      }
    }

    // Chart
    // Energy Flow Animation
    let flowAnimations = {
      solar: null,
      battery: null,
      grid: null
    };

    function animateBubble(bubbleId, powerWatts, maxPower = 5000) {
      const bubble = document.getElementById(bubbleId);
      if (!bubble) return;

      // Cancel existing animation
      if (flowAnimations[bubbleId.replace('-bubble', '')]) {
        cancelAnimationFrame(flowAnimations[bubbleId.replace('-bubble', '')]);
      }

      if (Math.abs(powerWatts) < 50) {
        // Hide bubble if power is near zero
        bubble.style.opacity = '0';
        return;
      }

      bubble.style.opacity = '0.8';

      // Determine path and direction
      let path, duration;
      if (bubbleId === 'solar-bubble') {
        path = document.getElementById('solar-flow');
        duration = 3000 + (3000 * (1 - Math.min(Math.abs(powerWatts), maxPower) / maxPower));
      } else if (bubbleId === 'battery-bubble') {
        path = document.getElementById('battery-flow');
        duration = 2000 + (2000 * (1 - Math.min(Math.abs(powerWatts), maxPower) / maxPower));
      } else if (bubbleId === 'grid-bubble') {
        path = document.getElementById('grid-flow');
        duration = 3000 + (3000 * (1 - Math.min(Math.abs(powerWatts), maxPower) / maxPower));
      }

      if (!path) return;

      const circle = bubble.querySelector('circle');
      const pathLength = path.getTotalLength();
      let startTime = null;

      function animate(currentTime) {
        if (!startTime) startTime = currentTime;
        const elapsed = currentTime - startTime;
        const progress = (elapsed % duration) / duration;
        const distance = pathLength * progress;
        const point = path.getPointAtLength(distance);

        circle.setAttribute('cx', point.x);
        circle.setAttribute('cy', point.y);

        if (Math.abs(powerWatts) >= 50) {
          flowAnimations[bubbleId.replace('-bubble', '')] = requestAnimationFrame(animate);
        }
      }

      flowAnimations[bubbleId.replace('-bubble', '')] = requestAnimationFrame(animate);
    }

    function updateEnergyFlow(data) {
      try {
        const solarKW = Math.max(0, data.solar.power) / 1000;
        const batteryKW = Math.abs(data.battery.power) / 1000;
        const gridKW = Math.max(0, data.grid.power) / 1000;
        const loadW = data.load.power;
        const soe = Math.round(data.battery.soe);

        // Triangular pyramid SVG updates
        const pyrSolar = document.getElementById('pyr-solar');
        if (pyrSolar) pyrSolar.textContent = solarKW.toFixed(1);
        
        const pyrBatt = document.getElementById('pyr-battery');
        if (pyrBatt) pyrBatt.textContent = batteryKW.toFixed(1);
        
        const pyrGrid = document.getElementById('pyr-grid');
        if (pyrGrid) pyrGrid.textContent = gridKW.toFixed(1);

        // Tile breakdown
        const tileSolar = document.getElementById('tile-solar');
        if (tileSolar) tileSolar.textContent = solarKW.toFixed(1);
        
        const tileBatt = document.getElementById('tile-battery');
        if (tileBatt) tileBatt.textContent = batteryKW.toFixed(1);
        
        const tileGrid = document.getElementById('tile-grid');
        if (tileGrid) tileGrid.textContent = gridKW.toFixed(1);

        // Update load display
        const pwLoad = document.getElementById('pw-load');
        if (pwLoad) pwLoad.textContent = loadW.toLocaleString() + ' W';

        // Animate pyramid dots based on power flow
        animateBubble('pyr-solar-dot', data.solar.power, 5000);
        animateBubble('pyr-battery-dot', data.battery.power, 5000);
        animateBubble('pyr-grid-dot', data.grid.power, 5000);

        // Update battery status display
        const soeStatusEl = document.getElementById('battery-soe-status');
        if (soeStatusEl) soeStatusEl.textContent = `Battery: ${soe}%`;

        console.log('Energy flow updated:', { solarKW, batteryKW, gridKW, loadW, soe });
      } catch (error) {
        console.error('Energy flow update error:', error);
      }
    }

    let chart;
    function updateChart(history) {
      const ctx = document.getElementById('powerChart').getContext('2d');
      
      const times = history.map(h => new Date(h.timestamp).toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'}));
      const loads = history.map(h => h.load);
      const solars = history.map(h => h.solar);

      if (chart) {
        chart.data.labels = times;
        chart.data.datasets[0].data = loads;
        chart.data.datasets[1].data = solars;
        chart.update();
      } else {
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: times,
            datasets: [
              {
                label: 'Load',
                data: loads,
                borderColor: '#64b5f6',
                backgroundColor: 'rgba(100, 181, 246, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointRadius: 0
              },
              {
                label: 'Solar',
                data: solars,
                borderColor: '#ffd700',
                backgroundColor: 'rgba(255, 215, 0, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { display: false },
              x: { display: false }
            }
          }
        });
      }
    }

    // Fetch crypto
    async function fetchCrypto() {
      try {
        const res = await fetch('/api/crypto');
        const data = await res.json();
        
        // BTC
        document.getElementById('btc-price').textContent = `$${data.btc.price.toLocaleString()}`;
        const btcEl = document.getElementById('btc-change');
        btcEl.textContent = `${data.btc.change24h}%`;
        btcEl.className = 'crypto-change ' + (parseFloat(data.btc.change24h) >= 0 ? 'up' : 'down');
        
        // ETH
        document.getElementById('eth-price').textContent = `$${data.eth.price.toLocaleString()}`;
        const ethEl = document.getElementById('eth-change');
        ethEl.textContent = `${data.eth.change24h}%`;
        ethEl.className = 'crypto-change ' + (parseFloat(data.eth.change24h) >= 0 ? 'up' : 'down');

        document.getElementById('crypto-card').classList.remove('loading');
      } catch (error) {
        console.error('Crypto error:', error);
      }
    }

    // Fetch data
    fetchWeather();
    fetchTemps();
    fetchCrypto();
    fetchPowerwall(); // Load initial 24-hour history for chart
    startPowerwallStream(); // Start live streaming

    // Refresh (Powerwall data comes via SSE, no polling needed)
    setInterval(fetchWeather, 300000);
    setInterval(fetchTemps, 600000);
    setInterval(fetchCrypto, 60000);

    // Dummy news
    document.getElementById('news').textContent = 'Kalshi fined a MrBeast editor for insider trading on markets related to the YouTube star';
  </script>
</body>
</html>
